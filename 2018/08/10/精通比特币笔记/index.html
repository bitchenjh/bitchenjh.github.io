<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>精通比特币笔记</title>
  <meta name="description" content="">
  <meta name="author" content="陈建辉">

  <meta name="keywords" content=""
  />

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="精通比特币笔记">
  <meta name="twitter:description" content="">

  <meta property="og:type" content="article">
  <meta property="og:title" content="精通比特币笔记">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="e"
  />


  <link rel="icon" type="image/png" href="/images/favicon.png" />
  <link href="/images/favicon.png" rel="shortcut icon" type="image/png">


  <link rel="stylesheet" href=" /css/main.css ">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="http://localhost:4000/2018/08/10/%E7%B2%BE%E9%80%9A%E6%AF%94%E7%89%B9%E5%B8%81%E7%AC%94%E8%AE%B0/">
  <link rel="alternate" type="application/rss+xml" title="陈建辉区块链博客" href="http://localhost:4000 /feed.xml
    ">

  <meta name="google-site-verification" content="1-1ZlHoRvM0T2FqPbW2S-qLgYXN6rsn52kErlMPd_gw" />

  <!-- 站点统计 -->
  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>

<!--注释掉51客服系统，这是个插件-->
  <!--<script>(function() {var _53code = document.createElement("script");_53code.src = "https://tb.53kf.com/code/code/10174862/1";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(_53code, s);})();</script>-->

  <!-- 百度统计 -->
  

  <!-- google 统计 -->
  

  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>

</head>


<body>

  <span class="mobile btn-mobile-menu">        
      <div class="nav_container">
         <nav class="nav-menu-item" style = "float:right">
            <i class="nav-menu-item">
              <a href="/#blog" title="" class="blog-button">  博客主页
              </a>
            </i>
            
                <i class="nav-menu-item">

                  <a href="/archive" title="archive" class="btn-mobile-menu__icon">
                      所有文章
                  </a>
                </i>
            
                <i class="nav-menu-item">

                  <a href="/tags" title="tags" class="btn-mobile-menu__icon">
                      分类
                  </a>
                </i>
            
                <i class="nav-menu-item">

                  <a href="/about" title="about" class="btn-mobile-menu__icon">
                      关于我
                  </a>
                </i>
            
          </nav>
          
      </div>
    </span> <header class="panel-cover panel-cover--collapsed" style="background-image: url('/images/background-cover.jpg')">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">
        <!-- 头像效果-start -->
        <div class="ih-item circle effect right_to_left">
          <a href="/#blog" title="前往 陈建辉区块链博客 的主页" class="blog-button">
            <div class="img"><img src="/images/avatar.jpg" alt="img"></div>
            <div class="info">
              <div class="info-back">
                <h2 style="font-size: 14px">
                  
                </h2>´
                <p style="font-size: 6px">
                   区块链从业人员 
                </p>
              </div>
            </div>
          </a>
        </div>
        <!-- 头像效果-end -->
        <h1 class="panel-cover__title panel-title"><a href="/#blog" title="link to homepage for 陈建辉区块链博客" class="blog-button">陈建辉区块链博客</a></h1>
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">陈建辉，项目经理，高级软件工程师，早期区块链从业人员，拥有多年传统金融软件开发经验</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" /> 


        <div class="navigation-wrapper">
          <div>
            <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">博客主页</a></li>
                
                <li class="navigation__item"><a href="/archive" title="archive">所有文章</a></li>
                
                <li class="navigation__item"><a href="/tags" title="tags">分类</a></li>
                
                <li class="navigation__item"><a href="/about" title="about">关于我</a></li>
                
              </ul>
            </nav>
          </div>
        </div>

      </div>
    </div>
  </div>

  
  <div class="panel-cover--overlay cover-clear"></div>
  

  </div>
</header>


  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <article class="post-container post-container--single" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title">精通比特币笔记</h1>
    <div class="post-meta">
      <img src="/images/calendar.png" width="20px"/>
      <time datetime="2018-08-10 00:00:00 +0800" itemprop="datePublished" class="post-meta__date date">2018-08-10</time>

      <span id="busuanzi_container_page_pv"> | 阅读：<span id="busuanzi_value_page_pv"></span>次</span>
    </p>
    </div>
  </header>

  <section class="post">
    <blockquote>
  <p>作者：陈建辉</p>

  <p>博客：www.chenjianhui.org</p>
</blockquote>

<blockquote>
  <p>备注：如有错误，请指正，不断更新迭代</p>
</blockquote>

<h3 id="找零">找零</h3>

<p>总的来讲，交易是将钱从交易输入移至输出。输入是指钱币的来源，通常是之前一笔交易的输出。交易输出将约定 金额发送到新的所有者的比特币地址，并将找零输出返回原来原来所有者。 一笔交易的输出可以被当做另一笔新交 易的输入，这样随着钱从一个地址被移动到另一个地址的同时形成了一条所有权链</p>

<h3 id="bitcoin-源码安装">bitcoin 源码安装</h3>

<p><code class="highlighter-rouge">brew install automake berkeley-db4 libtool boost --c++11 miniupnpc openssl pkg-config protobuf python3 qt libevent</code></p>

<h3 id="私钥">私钥</h3>

<p>以下是一个随机生成的私钥(k)，以十六进制格式表示(256位的二进制数，以64位十六进制数显示，每个十六 进制数占4位):
1E99423A4ED27608A15A2616A2B0E9E52CED330AC530EDCC32C8FFC6A526AEDD</p>

<h3 id="比特币地址">比特币地址</h3>

<p>比特币地址可由公钥经过单向的加密哈希算法得到。哈希算法是一种单向函数，接收任意长度的输入产生指纹或哈 希。加密哈希函数在比特币中被广泛使用 :比特币地址、脚本地址以及在挖矿中的工作量证明算法。由公钥生成比 特币地址时使用的算法是Secure Hash Algorithm (SHA)和the RACE Integ rity Primitives Evaluation Message Digest (RIPEMD)，具体地说是SHA256和RIPEMD160。
以公钥 K 为输入，计算其SHA256哈希值，并以此结果计算RIPEMD160 哈希值，得到一个长度为160位(20字 节)的数字: A = RIPEMD160(SHA256(K))
公式中，K是公钥，A是生成的比特币地址。
提示比特币地址与公钥不同。比特币地址是由公钥经过单向的哈希函数生成的。比特币地址产生过程如图
<img src="http://p96hyfqf4.bkt.clouddn.com/%E6%AF%94%E7%89%B9%E5%B8%81%E5%9C%B0%E5%9D%80%E7%94%9F%E4%BA%A7%E8%BF%87%E7%A8%8B.png" alt="" /></p>

<p>base58check 编码过程如图
<img src="http://p96hyfqf4.bkt.clouddn.com/base58check%E7%BC%96%E7%A0%81.png" alt="" /></p>

<p>比特币btc地址开头总是1，长度27位到34位。</p>

<p>多重签名地址用的是script hash, [prefix]为5，base58编码后，地址首位为’3’</p>

<h3 id="钱包">钱包</h3>

<p>“钱包”一词在比特币中有多重含义。 广义上，钱包是一个应用程序，为用户提供交互界面。 钱包控制用户访问权 限，管理密钥和地址，跟踪余额以及创建和签名交易。 狭义上，即从程序员的角度来看，“钱包”是指用于存储和管理用户密钥的数据结构</p>

<h3 id="交易">交易</h3>

<p>我们可以使用Bitcoin Core的命令行界面(getrawtransaction和decodeawtransaction)来检索“原始”交 易，对其进行解码，并查看它包含的内容。 结果如下:</p>

<p><strong>交易被解码后</strong>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="w">  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">

     </span><span class="nt">"locktime"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nt">"vin"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"txid"</span><span class="p">:</span><span class="s2">"7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"vout"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nt">"scriptSig"</span><span class="p">:</span><span class="w">
  </span><span class="s2">"3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe
  9f6addac960298cad530a863ea8f53982c09db8f6e3813[ALL]
  0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c
  04f4938de5cc17b4a10fa336a8d752adf"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"sequence"</span><span class="p">:</span><span class="w"> </span><span class="mi">4294967295</span><span class="w">
      </span><span class="p">}</span><span class="w">
</span><span class="p">],</span><span class="w"> </span><span class="nt">"vout"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.01500000</span><span class="p">,</span><span class="w">
        </span><span class="nt">"scriptPubKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"OP_DUP OP_HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 OP_EQUALVERIFY
  OP_CHECKSIG"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.08450000</span><span class="p">,</span><span class="err">交易输出包含两部分</span><span class="p">:</span><span class="w">
        </span><span class="s2">"scriptPubKey"</span><span class="err">:</span><span class="w"> </span><span class="s2">"OP_DUP OP_HASH160 7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY
  OP_CHECKSIG"</span><span class="p">,</span><span class="w">
      </span><span class="err">}</span><span class="w">
</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w">

</span></code></pre>
</div>

<h4 id="utxo-未花费的交易输出">UTXO-未花费的交易输出</h4>

<p>比特币完整节点跟踪所有可找到的和可使用的输出，称为 “未花费的交易输出”(unspent transaction outputs)，即UTXO
用户的比特币“余额”是指用户钱包中可用的UTXO总和，而他们可能分散 在数百个交易和区块中</p>

<p><strong>每一个未被使用的 vout 就是一个 UTXO（Unspent Transaction Output）</strong>，我们可以通过其中的 addresses 字段找到持有当前输出的地址。</p>

<p>一笔比特币交易通过使用所有者的签名来解锁UTXO，并通过使用新的所有者的比特币地址来锁定并创建UTXO。给某人发送比特币实际上是创造新的UTXO，注册到那个人的地址。</p>

<p><strong>交易输出</strong></p>

<p>交易输出包含两部分:</p>
<ul>
  <li>一定量的比特币，面值为“聪”(satoshis) ，是最小的比特币单位;</li>
  <li>确定花费输出所需条件的加密难题(cryptographic puzzle)</li>
</ul>

<p>在 JSON 编码中，输出位于名为 vout 的数组(列表)中:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>"vout": [ {
     "value": 0.01500000,
     "scriptPubKey": "OP_DUP OP_HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 OP_EQUALVERIFY
 OP_CHECKSIG"
}, {
     "value": 0.08450000,
     "scriptPubKey": "OP_DUP OP_HASH160 7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY
 OP_CHECKSIG",
} ]
</code></pre>
</div>

<p>####-交易输入和签名</p>

<p>交易输入将UTXO(通过引用)标记为将被消费，并通过解锁脚本提供所有权证明。
让我们更详细地看一下输入的组件。输入的第一部分是一个指向UTXO的指针，通过指向UTXO被记录在区块链中所 在的交易的哈希值和序列号来实现。 第二部分是解锁脚本，钱包构建它用以满足设定在UTXO中的支出条件。 大多 数情况下，解锁脚本是一个证明比特币所有权的数字签名和公钥，但是并不是所有的解锁脚本都包含签名。 第三部 分是序列号，稍后再讨论。
让我们更详细地看一下输入的组件。输入的第一部分是一个指向UTXO的指针，通过指向UTXO被记录在区块链中所 在的交易的哈希值和序列号来实现。 第二部分是解锁脚本，钱包构建它用以满足设定在UTXO中的支出条件。 大多 数情况下，解锁脚本是一个证明比特币所有权的数字签名和公钥，但是并不是所有的解锁脚本都包含签名。 第三部 分是序列号，稍后再讨论。</p>
<div class="highlighter-rouge"><pre class="highlight"><code>"vin": [ {
      "txid": "7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18",
      "vout": 0,
      "scriptSig" :
  "3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe
  9f6addac960298cad530a863ea8f53982c09db8f6e3813[ALL]
  0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c
  04f4938de5cc17b4a10fa336a8d752adf",
      "sequence": 4294967295
    }
]
</code></pre>
</div>
<p>如您所见，列表中只有一个输入(因为一个UTXO包含足够的值来完成此付款)。 输入包含四个元素:</p>
<ul>
  <li>一个交易ID，引用包含正在使用的UTXO的交易</li>
  <li>一个输出索引(vout)，用于标识来自该交易的哪个UTXO被引用(第一个为零)</li>
  <li>一个 scriptSig(解锁脚本)，满足放置在UTXO上的条件，解锁它用于支出</li>
  <li>一个序列号(稍后讨论)</li>
</ul>

<p>通过 txid 和 vout 两个字段，我们能够在区块链网络中定位到唯一一个 UTXO，这个 UTXO 加上持有当前 UTXO 的地址对交易的签名构成了一个交易输入。</p>

<h4 id="脚本">脚本</h4>

<p>比特币脚本是一种基于逆波兰表示法的基于堆栈的执行语言。堆栈允许两类操作：推送和弹出。数字（常数）被推送至堆栈，操作符向堆栈推送（或移除）一个或多个参数，对它们进行处理向堆栈推送一个结果，最终产生一个真或假的结果
脚本分为锁定脚本和解锁脚本。锁定脚本和UTXO是对应的，一个UTXO中包含一个锁定脚本
锁定脚本和UTXO 关联，而解锁脚本和某笔交易关联。
锁定脚本被叫做scriptPubKey, 解锁脚本被叫做ScriptSig。
脚本究竟是什么形式存在的呢？其实就是一堆命令加参数。</p>

<p>脚本样式：
<img src="http://p96hyfqf4.bkt.clouddn.com/%E8%84%9A%E6%9C%AC%E6%A0%B7%E5%BC%8F.png" alt="" /></p>

<p>dup, hash160等是命令，sig, pubk是参数。</p>

<p>脚本类型</p>
<ul>
  <li>P2PKH（Pay-to-Public-Key-Hash），即支付给公钥的哈希即地址，接收方只需要使用地址对应的私钥对该输出进行签名，即可花掉该输出。</li>
  <li>Multisig(多重签名)</li>
  <li>P2SH（Pay-to-Script-Hash），支付脚本的哈希。拿多重签名来举例，它要求该输出同时要有N把私钥中的M把私钥（M&lt;=N）同时签名才能花掉该资产，它类似于现实生活中需要多把钥匙才能同时打开的保险柜，只是更加灵活。</li>
</ul>

<p><strong>比特币实现花钱的方式</strong></p>

<p>假设B要花A转给他的钱
A在交易M的输出中，写一个脚本（输出脚本），请写明金额，表示把钱转给A。
B在交易N的输入中，也写一个脚本（签名脚本），意思是要花A在交易M中转给他的钱。
当交易M在网上传播时，比特币节点验证交易M，只要签名脚本符合输出脚本的要求，节点就认可B能够执行这个花费。
P2PKH
验证的一种方法是，输出脚本中包含B的公钥，签名脚本包含B用私钥所作的签名。
这样，节点就可以用公钥验证签名。
A在交易M中的这种支付，就是支付给某人的公钥，也就是支付给P2PKH地址。</p>

<p>Multisig
后来，有人想到了高级的玩法：
在输出脚本中包含M个公钥，签名脚本中至少要包含N个私钥的签名，比特币节点才能验证通过，允许花费。这个就是多签名脚本（Multisig）。</p>

<p>P2SH
后来，又有人想到了更高级的玩法，是这样：
B对A说，你别管怎么验证，我给你一个哈希值，我在签名脚本中提供输出脚本，只要我提供的输出脚本的哈希值与给你的哈希值对得上，你就用我提供的输出脚本进行验证。
这样，B就可以随意定义自己希望的输出脚本，这就是P2SH地址，以数字3开头的比特币地址是P2SH地址。
P2SH也可以实现P2PKH地址和Multisig的功能。</p>

<p>比如在比特币中，P2PKH的脚本规则如下：
Pubkey script: OP_DUP OP_HASH160 <PubKeyHash> OP_EQUALVERIFY OP_CHECKSIG
Signature script: <sig> <pubkey></pubkey></sig></PubKeyHash></p>

<p>P2SH的脚本规则如下：
Pubkey script: OP_HASH160 &lt;Hash160(redeemScript)&gt; OP_EQUAL
Signature script: <sig> [sig] [sig...] <redeemScript>
以数字3开头的比特币地址是P2SH地址</redeemScript></sig></p>

<p>在上述的2种脚本规则里，Pubkey script代表着锁定脚本，Signature script代表着解锁脚本。OP_开头的单词是相关的脚本命令，也是”虚拟机”所能解析的指令。这些命令规则根据Pubkey script的不同来进行划分，它也决定着解锁脚本的规则。</p>

<p><strong>脚本语言执行原理</strong></p>

<p>脚本的执行流程基于堆栈模型。类似于表达式求值的实现逻辑。</p>

<p>输入的形式：表达式，例如2*(3+4)</p>

<p>输出的形式：运算结果</p>

<p>其中2,3,4相当于脚本中的参数，而*,+号是脚本的命令。</p>

<p>实现逻辑就是基于栈结构，初始都入栈，然后出栈判断如何操作。</p>

<p>比特币脚本也是类似的实现逻辑，而且它更加简单(没有优先级判断那些)</p>

<p>脚本执行流程
<img src="http://p96hyfqf4.bkt.clouddn.com/%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86.png" alt="" /></p>

<p>上图是一个很简单的脚本，就是判断2 add 3是否equal 5</p>

<p><strong>基于比特币P2PKH交易类型的比特币交易示例</strong></p>

<p>假设alice要向bob支付0.015比特币, alice会用到一个UTXO(假设是单输入，单输出)，这个UTXO带有一个锁定脚本，为交易设置“障碍”。</p>

<p>锁定脚本如下:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>OP_DUP OP_HASH160 be10f0a78f5ac63e8746f7f2e62a5663eed05788 OP_EQUALVERIFY OP_CHECKSIG
123
</code></pre>
</div>

<ul>
  <li>OP_DUP:复制栈顶数据，然后该数据放置栈顶</li>
  <li>OP_HASH160:对栈顶数据执行ripemd160(sha256(data)) (这其实是两次摘要计算，不详述)</li>
  <li>be10f0a…:bob的比特币地址</li>
  <li>OP_EQUALVERIFY:对比栈顶的两个数据，如果相等都被移除</li>
  <li>OP_CHECKSIG:验证签名</li>
</ul>

<p>bob如果要接收这笔比特币(另一种说法是bob可以引用该笔输出)，就要给出一个<strong>解锁脚本</strong>,然后解锁脚本和锁定脚本组合后执行的结果为真才能确认交易有效。</p>

<p>解锁脚本如下:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>3046022100ba1427639c9f67f2ca1088d0140318a98cb1e84f604dc90ae00ed7a5f9c61cab02210094233d018f2f014a5864c9e0795f13735780cafd51b950f503534a6af246aca301
03a63ab88e75116b313c6de384496328df2656156b8ac48c75505cd20a4890f5ab
123
</code></pre>
</div>

<p>看起来是一堆数字，其实『签名』和『公钥』（sig &amp; pubkey）的组合。签名是bob的私钥对该笔交易的信息加密的结果，公钥就是指的bob的公钥。</p>

<p><strong>由于私钥只有bob才知道，所以也只有他才能拿出正确的签名。</strong></p>

<p>下面是脚本执行的过程:</p>

<p><img src="http://p96hyfqf4.bkt.clouddn.com/%E9%94%81%E5%AE%9A%E8%84%9A%E6%9C%AC%E7%A4%BA%E4%BE%8B%E6%B5%81%E7%A8%8B.png" alt="" /></p>

<p><img src="http://p96hyfqf4.bkt.clouddn.com/%E8%A7%A3%E9%94%81%E8%84%9A%E6%9C%AC%E7%A4%BA%E4%BE%8B.png" alt="" /></p>

<p>简单的几十个字节的脚本，就完成了交易的验证确保该笔转账的合法性。</p>

<h3 id="比特币网络">比特币网络</h3>

<p>比特币网络节点，具有所有四个功能:钱包，矿工，完整的区块链数据库和网络路由</p>

<h3 id="比特币区块">比特币区块</h3>

<h4 id="区块头">区块头</h4>

<p>比特币区块由区块头和该区块所包含的交易列表组成。区块头大小为80字节，其构成包括：</p>

<p>　　 4字节：版本号
　　32字节：上一个区块的哈希值
　　32字节：交易列表的Merkle根哈希值
　　 4字节：当前时间戳
　　 4字节：当前难度值
　　 4字节：随机数Nonce值
此80字节长度的区块头，即为比特币Pow算法的输入字符串</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class CBlockHeader
{
public:
    //版本号
    int32_t nVersion;
    //上一个区块的哈希值
    uint256 hashPrevBlock;
    //交易列表的Merkle根哈希值
    uint256 hashMerkleRoot;
    //当前时间戳
    uint32_t nTime;
    //当前挖矿难度，nBits越小难度越大
    uint32_t nBits;
    //随机数Nonce值
    uint32_t nNonce;
    //其它代码略
};

class CBlock : public CBlockHeader
{
public:
    //交易列表
    std::vector&lt;CTransactionRef&gt; vtx;
    //其它代码略
};
//代码位置src/primitives/block.h

</code></pre>
</div>

<h4 id="merkle树">Merkle树</h4>

<p>区块链中的每个区块都包含了产生于该区块的所有交易，且以Merkle树表示。
在比特币网络中，Merkle树被用来归纳一个区块中的所有交易，同时生成整个交易集合的数字指纹，且提供了一种 校验区块是否存在某交易的高效途径</p>

<p>Merkle树被SPV节点广泛使用。SPV节点不保存所有交易也不会下载整个区块，仅仅保存区块头。它们使用认证路
径或者Merkle路径来验证交易存在于区块中，而不必下载区块中所有交易。</p>

<p>默克尔树中所有节点图如下：
<img src="http://p96hyfqf4.bkt.clouddn.com/Merkle%E6%A0%91.png" alt="" /></p>

<p>所有的交易都并不存储在Merkle树中，而是将数据哈希化，然后将哈希值存储至相应的叶子节点。这些叶子节点分
别是HA、HB、HC和HD: HA = SHA256(SHA256(Transaction A))
将相邻两个叶子节点的哈希值串联在一起进行哈希，这对叶子节点随后被归纳为父节点。 例如，为了创建父节点 HAB，子节点 A和子节点B的两个32字节的哈希值将被串联成64字节的字符串。随后将字符串进行两次哈希来产生 父节点的哈希值: HAB = SHA256(SHA256(HA + HB))
继续类似的操作直到只剩下顶部的一个节点，即Merkle根。产生的32字节哈希值存储在区块头，同时归纳了四个 交易的所有数据。图9-2展示了如何通过成对节点的哈希值计算Merkle树的根。</p>

<h3 id="挖矿">挖矿</h3>

<p>寻找一个比特币区块需要整个网络花费10分钟来处理，每发现2,016个区块时会根据前2,016个区块完成的时 间对难度进行调整。
这个公式可以总结为如下形式:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>  New Difficulty = Old Difficulty \* \(Actual Time of Last 2016 Blocks / 20160 minutes\)

</code></pre>
</div>

<h2 id="难度值">难度值</h2>

<p>难度值（difficulty）是矿工们在挖矿时候的重要参考指标，它决定了矿工大约需要经过多少次哈希运算才能产生一个合法的区块。比特币的区块大约每10分钟生成一个，如果要在不同的全网算力条件下，新区块的产生保持都基本这个速率，难度值必须根据全网算力的变化进行调整。简单地说，难度值被设定在无论挖矿能力如何，新区块产生速率都保持在10分钟一个。</p>

<p>难度的调整是在每个完整节点中独立自动发生的。每2016个区块，所有节点都会按统一的公式自动调整难度，这个公式是由最新2016个区块的花费时长与期望时长（期望时长为20160分钟即两周，是按每10分钟一个区块的产生速率计算出的总时长）比较得出的，根据实际时长与期望时长的比值，进行相应调整（或变难或变易）。也就是说，如果区块产生的速率比10分钟快则增加难度，比10分钟慢则降低难度。</p>

<p>这个公式可以总结为如下形式：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>新难度值 = 旧难度值 * ( 过去2016个区块花费时长 / 20160 分钟 )
</code></pre>
</div>

<p>工作量证明需要有一个目标值。比特币工作量证明的目标值（Target）的计算公式如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>目标值 = 最大目标值 / 难度值
其中最大目标值为一个恒定值：
0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
</code></pre>
</div>

<p>目标值的大小与难度值成反比。比特币工作量证明的达成就是矿工计算出来的区块哈希值必须小于目标值。</p>

<p>比特币工作量证明的过程，就是通过不停的变换区块头（即尝试不同的nouce值）作为输入进行SHA256哈希运算，找出一个特定格式哈希值的过程（即要求有一定数量的前导0）。而要求的前导0的个数越多，代表难度越大。</p>

<h4 id="51攻击或者双花">51%攻击或者双花</h4>

<p>在这里简单解释一下“双花”（Double Spending）。从字面上看，就是一笔钱被花出去了两次。以BTG事件为例，就是黑客临时控制了区块链之后，不断地在交易所发起交易和撤销交易，将一定数量的BTG在多个钱包地址间来回转，一笔“钱”被花了多次，黑客的地址因此得到了388201个BTG。</p>

<p>为了更好地理解挖矿的目的，让我们分析比特币网络出现恶意攻击者时会发生什么。因为比特币的密码学基础是非常安全的，所以攻击者会选择攻击没有被密码学直接保护的部分：交易顺序。攻击者的策略非常简单：</p>

<p>向卖家发送100BTC购买商品（尤其是无需邮寄的电子商品）。
等待直至商品发出。
创建另一笔交易，将相同的100BTC发送给自己的账户。
使比特币网络相信发送给自己账户的交易是最先发出的。
一旦步骤（1）发生，几分钟后矿工将把这笔交易打包到区块，假设是第270000个区块。大约一个小时以后，在此区块后面将会有五个区块，每个区块间接地指向这笔交易，从而确认这笔交易。这时卖家收到货款，并向买家发货。因为我们假设这是数字商品，攻击者可以即时收到货。现在，攻击者创建另一笔交易，将相同的100BTC发送到自己的账户。如果攻击者只是向全网广播这一消息，这一笔交易不会被处理。矿工会运行状态转换函数APPLY(S,TX)，发现这笔交易将花费已经不在状态中的UTXO。所以，攻击者会对区块链进行分叉，将第269999个区块作为父区块重新生成第270000个区块，在此区块中用新的交易取代旧的交易。因为区块数据是不同的，这要求重新进行工作量证明。另外，因为攻击者生成的新的第270000个区块有不同的哈希，所以原来的第270001到第270005的区块不指向它，因此原有的区块链和攻击者的新区块是完全分离的。在发生区块链分叉时，区块链长的分支被认为是诚实的区块链，合法的的矿工将会沿着原有的第270005区块后挖矿，只有攻击者一人在新的第270000区块后挖矿。攻击者为了使得他的区块链最长，他需要拥有比除了他以外的全网更多的算力来追赶（即51%攻击）。</p>

<h4 id="分叉">分叉</h4>

<ul>
  <li>
    <p>硬分叉
网络也可能会分叉到两条链条，这是由于共识规则的变化。这种分叉称为硬分叉，因为这种分叉
后，网络不会重新收敛到单个链路上。相反，这两条链子独立发展。当比特币网络的一部分节点按照与网络的其余
部分节点不同的一致性规则运行时，硬分叉就会发生</p>
  </li>
  <li>
    <p>软分叉</p>
  </li>
</ul>

<h4 id="扩容">扩容</h4>

<p>比特币协议规定，平均10分钟诞生一个区块。区块的大小只有 1MB，最多只能包含2000多笔交易。也就是说，比特币网络每10分钟，最多只能处理2000多笔交易，换算一下，就是处理速度为3～5笔/秒。全世界的比特币交易这么多，可是区块链每秒最多只能处理5笔，这已经成为制约比特币发展的一个瓶颈。
很早就有人呼吁改革比特币协议，提升处理速度。于是诞生了一个新协议，称为 Bitcoin Cash（简称 BCH）。这种新货币其他方面都与比特币一致，就是每个区块的大小从 1MB 增加到了 8MB，因此处理速度提升了8倍，手续费也低得多。该协议是对原有区块链的分叉，因此当时持有比特币的人，等于一人获赠了一份同样数量的 BCH。</p>

  </section>
  <h2 style="color:red"><strong>温馨提示：希望本博文对大家带来帮助，欢迎交流合作，请联系：905739007(QQ)</strong></h2>
</article>

<section>

            <div class="content-play">
              <p><a href="javascript:void(0)" onclick="dashangToggle()" class="dashang" title="打赏，支持一下">打赏一个呗</a></p>
              <div class="hide_box-play"></div>
              <div class="shang_box-play">
                <a class="shang_close-play" href="javascript:void(0)" onclick="dashangToggle()" title="关闭"><img src="/images/payimg/close.jpg" alt="取消" /></a>
                <div class="shang_tit-play">
                  <p>感谢您的支持，我会继续努力的!</p>
                </div>
                <div class="shang_payimg">
                    <img src="/images/payimg/alipayimg.jpg" alt="扫码支持" title="扫一扫" />
                </div>
              <div class="shang_payimg">    
                    <img src="/images/payimg/weipayimg.jpg" alt="扫码支持" title="扫一扫" />
                </div>
                <div class="pay_explain">扫码打赏，你说多少就多少</div>
                <div class="shang_payselect">
                  <div class="pay_item checked" data-id="alipay">
                    <span class="pay_logo"><img src="/images/payimg/alipay.jpg" alt="支付宝" /></span>
                  </div>
                  <div class="pay_item" data-id="weipay">
                    <span class="pay_logo"><img src="/images/payimg/wechat.jpg" alt="微信" /></span>
                  </div>
                </div>
                <div class="shang_info-play">
                  <p>打开<span id="shang_pay_txt">支付宝</span>扫一扫，即可进行扫码打赏哦</p>
                </div>
              </div>
            </div>
            <script type="text/javascript">
            function dashangToggle(){
              $(".hide_box-play").fadeToggle();
              $(".shang_box-play").fadeToggle();
            }
            </script>

            <div style="text-align:center;margin:50px 0; font:normal 14px/24px 'MicroSoft YaHei';"></div>

            <style type="text/css">
              .content-play{width:80%;margin-top: 20px;margin-bottom: 10px;height:40px;}
              .hide_box-play{z-index:999;filter:alpha(opacity=50);background:#666;opacity: 0.5;-moz-opacity: 0.5;left:0;top:0;height:99%;width:100%;position:fixed;display:none;}
              .shang_box-play{width:540px;height:540px;padding:10px;background-color:#fff;border-radius:10px;position:fixed;z-index:1000;left:50%;top:50%;margin-left:-280px;margin-top:-280px;border:1px dotted #dedede;display:none;}
              .shang_box-play img{border:none;border-width:0;}
              .dashang{display:block;width:100px;margin:5px auto;height:25px;line-height:25px;padding:10px;background-color:#E74851;color:#fff;text-align:center;text-decoration:none;border-radius:10px;font-weight:bold;font-size:16px;transition: all 0.3s;}
              .dashang:hover{opacity:0.8;padding:15px;font-size:18px;}
              .shang_close-play{float:right;display:inline-block;
                margin-right: 10px;margin-top: 20px;
              }
              .shang_logo{display:block;text-align:center;margin:20px auto;}
              .shang_tit-play{width: 100%;height: 75px;text-align: center;line-height: 66px;color: #a3a3a3;font-size: 16px;background: url('/images/payimg/cy-reward-title-bg.jpg');font-family: 'Microsoft YaHei';margin-top: 7px;margin-right:2px;}
              .shang_tit-play p{color:#a3a3a3;text-align:center;font-size:16px;}
              .shang_payimg{width:140px;padding:10px;padding-left: 80px; /*border:6px solid #EA5F00;**/margin:0 auto;border-radius:3px;height:140px;display:inline-block;}
              .shang_payimg img{display:inline-block;margin-right:10px;float:left;text-align:center;width:140px;height:140px; }
              .pay_explain{text-align:center;margin:10px auto;font-size:12px;color:#545454;}
              .shang_payselect{text-align:center;margin:0 auto;margin-top:40px;cursor:pointer;height:60px;width:500px;margin-left:110px;}
              .shang_payselect .pay_item{display:inline-block;margin-right:140px;float:left;}
              .shang_info-play{clear:both;}
              .shang_info-play p,.shang_info-play a{color:#C3C3C3;text-align:center;font-size:12px;text-decoration:none;line-height:2em;}
            </style>

       <ul class="pager">
        
        <li class="previous">
            <a href="/2018/07/13/%E9%93%BE%E7%A0%812-%E6%A6%82%E5%BF%B5%E4%BB%A5%E5%8F%8A%E4%BD%BF%E7%94%A8/" data-toggle="tooltip" data-placement="top" title="链码2 概念以及使用">上一篇：  <span>链码2 概念以及使用</span>
            </a>
        </li>
        
        
        <li class="next">
            <a href="/2018/08/23/Hash%E7%AE%97%E6%B3%95/" data-toggle="tooltip" data-placement="top" title="Hash算法">下一篇：  <span>Hash算法</span>
            </a>
        </li>
        
    </ul>
</section>

<section class="post-comments">
  <!--PC和WAP自适应版-->
<div id="SOHUCS" sid=精通比特币笔记 ></div>
<script type="text/javascript">
(function(){
var appid = 'cytfSz8yx';
var conf = 'prod_ad710bf09d342725ed536beddc68aa27';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
</section>

 <section class="footer">
  <footer>
    <div class="footer_div">
      <nav class="cover-navigation navigation--social">
        <ul class="navigation">

          
          <!-- Weibo -->
          <li class="navigation__item_social">
            <a href="http://weibo.com/http://weibo.com/bitchenjh" title="@http://weibo.com/bitchenjh 的微博" target="_blank">
              <i class='social fa fa-weibo fa-2x'></i>
              <span class="label">Weibo</span>
            </a>
          </li>
           
          <!-- Github -->
          <li class="navigation__item_social">
            <a href="https://github.com/bitchenjh" title="@bitchenjh 的 Github" target="_blank">
              <i class='social fa fa-github fa-2x'></i>
              <span class="label">Github</span>
            </a>
          </li>
            

          <!-- RSS -->
          <li class="navigation__item_social">
            <a href="/feed.xml" rel="author" title="RSS" target="_blank">
              <i class='social fa fa-rss fa-2x'></i>
              <span class="label">RSS</span>
            </a>
          </li>

          
          <!-- Email -->
          <li class="navigation__item_social">
            <a href="mailto:cjhcjlu@163.com" title="Contact me">
              <i class='social fa fa-envelope fa-2x'></i>
              <span class="label">Email</span>
            </a>
          </li>
          

        </ul>
      </nav>

    </div>

    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <thead>
        <tr id="bar_head">
          <th colspan="11">友情链接</th>
        </tr>
      </thead>

      <tr align="center" valign="middle">
          <td><a href="http://www.kongyixueyuan.com">区块链技术视频网站</a></td>

          <td><a href="https://www.ethereum.org">以太坊官网</a></td>

          <td><a href="https://solidity.readthedocs.io/en/develop/">Solidity</a></td>

          <td><a href="http://truffleframework.com/">Truffle FrameWork</a></td>

          <td><a href="http://embark.readthedocs.io">Embark FrameWork</a></td>

      </tr>
      <tr align="center" valign="middle">

          <td><a href="https://www.ibm.com/developerworks/community/groups/service/html/communityview?communityUuid=3302cc3b-074e-44da-90b1-5055f1dc0d9c&amp;lang=zh">IBM开源技术微讲堂</a></td>

          <td><a href="https://www.bitcoin.com/">Bitcoin.com</a></td>

          <td><a href="https://github.com/bitshares/bitshares1-core">bitshares1-core</a></td>

          <td><a href="https://ipfs.io">ipfs官网</a></td>

          <td><a href="http://ipfser.org">ipfs中文网</a></td>

      </tr>
    </table>

    <div class="footer_div">
      <p class="copyright text-muted">
        Copyright &copy; 2018 陈建辉区块链博客 QQ：905739007
      </p>
      <div align="right">
        <link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
        <!-- 访问统计 -->
        <span id="busuanzi_container_site_pv">
            本站总访问量
            <span id="busuanzi_value_site_pv"></span>次
        </span>

      </div>
      <div>
  </footer>
</section>

    </div>
  </div>

  <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

<script type="text/javascript" src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


</body>

</html>